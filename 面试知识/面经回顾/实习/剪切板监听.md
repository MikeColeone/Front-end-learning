### **1. 剪切板的设计**

#### **1.1 功能目标**

- **核心功能**：监听用户的复制操作（如鼠标划词或 `Ctrl+C`），从剪切板中提取内容（如电话号码），并验证其格式是否符合预期。
- **主要用途**：
  - 实现划词取号功能：用户划词后，自动识别电话号码并显示小窗口。
  - 支持剪切板内容的读取、验证和恢复，避免覆盖用户的剪切板内容。

#### **1.2 设计思路**

1. **监听用户操作**：
   
   - 使用 `uiohook-napi` 监听鼠标和键盘事件，捕获用户的划词和复制操作。
   - 判断用户是否执行了鼠标划词或 `Ctrl+C` 操作。

2. **模拟复制操作**：
   
   - 在用户划词后，模拟 `Ctrl+C` 操作，将选中的内容复制到剪切板。

3. **读取剪切板内容**：
   
   - 使用 Electron 的 clipboard 模块读取剪切板中的文本内容。

4. **验证内容**：
   
   - 使用正则表达式验证剪切板内容是否符合电话号码格式。

5. **恢复剪切板内容**：
   
   - 在验证完成后，将剪切板恢复为用户原本的内容，避免覆盖用户的剪切板数据。

6. **显示小窗口**：
   
   - 如果验证通过，显示一个小窗口，提示用户已识别的电话号码。

---

### **2. 解决的问题**

1. **自动化划词取号**：
   
   - 用户无需手动复制或输入电话号码，划词后自动识别并显示。

2. **剪切板保护**：
   
   - 避免覆盖用户的剪切板内容，确保用户的复制操作不受干扰。

3. **实时验证**：
   
   - 在用户划词后，实时验证内容是否符合预期格式（如电话号码）。

4. **用户体验优化**：
   
   - 通过小窗口提示用户已识别的内容，提升交互体验。

---

### **3. 节流思想的应用**

#### **3.1 为什么需要节流**

1. **防止高频触发**：
   
   - 用户可能快速连续划词或按下 `Ctrl+C`，导致剪切板逻辑被多次触发。
   - 节流可以限制操作频率，避免重复执行逻辑。

2. **确保剪切板内容正确性**：
   
   - 剪切板内容的更新需要一定时间，如果立即读取，可能会读取到旧数据或空数据。
   - 延时操作可以确保剪切板内容已更新。

3. **保护用户剪切板内容**：
   
   - 在模拟 `Ctrl+C` 操作后，用户可能手动按下 `Ctrl+C`，导致剪切板内容被覆盖。
   - 节流可以避免在短时间内重复操作剪切板。

#### **3.2 节流的实现**

- **限制两次划词操作的时间间隔**：
  
  ```js
  let now = new Date().getTime();
  
  if (now - time < 300) {
  
    isCopy = true;
  
  }
  
  time = now; // 更新上一次操作的时间
  ```
  
  

- **延时读取剪切板内容**：
  
  ```js
  setTimeout(() => {
  
    const text = clipboard.readText('clipboard');
  
    console.log("延时读取剪切板内容:", text);
  
  }, 50);
  ```
  
  

- **限制剪切板操作次数**：
  
  ```js
  if (count < 2) {
  
    clipboard.clear();
  
  }
  ```
  
  

---

### **4. 易踩坑的点**

#### **4.1 剪切板内容丢失**

- **问题**：在模拟 `Ctrl+C` 操作后，用户的剪切板内容可能被覆盖。

- **解决**：
  
  - 在读取和验证完成后，将剪切板恢复为用户原本的内容：
    
    ```js
    if (lastText) {
    
      clipboard.writeText(lastText);
    
    } else if (!lastImg.isEmpty()) {
    
      clipboard.writeImage(lastImg);
    
    } else {
    
      clipboard.clear();
    
    }
    ```
    
    

#### **4.2 高频触发导致性能问题**

- **问题**：用户快速连续划词或按下 `Ctrl+C`，可能导致剪切板逻辑被多次触发，影响性能。

- **解决**：
  
  ```js
  let now = new Date().getTime();
  
  if (now - time < 300) {
  
    isCopy = true;
  
  }
  ```
  
  

#### **4.3 剪切板内容读取失败**

- **问题**：剪切板内容的更新需要一定时间，如果立即读取，可能会读取到旧数据或空数据。

- **解决**：
  
  - 使用延时操作，确保剪切板内容已更新：
    
    ```js
    setTimeout(() => {
    
      const text = clipboard.readText('clipboard');
    
    }, 50);
    ```
    
    

#### **4.4 正则验证不准确**

- **问题**：正则表达式可能无法覆盖所有电话号码格式。

- **解决**：
  
  - 根据业务需求优化正则表达式：
    
    ```js
    const reg = /^(1[3-9]\d{9}|0\d{2,3}-?\d{7,8}|400\d{7}|400\d{8})$/;
    ```
    
    

#### **4.5 小窗口显示问题**

- **问题**：小窗口可能在用户快速操作时频繁弹出或隐藏，影响用户体验。

- **解决**：
  
  ```js
  //使用计时器限制小窗口的显示频率：
  
  timer = setTimeout(() => {
  
    if (cursorOut) {
  
      win.hide();
  
    }
  
  }, 5000);
  ```

---

### **5. 优化建议**

#### **5.1 使用防抖优化**

- **原理**：在用户停止操作后再执行剪切板逻辑，避免频繁触发。

- **实现**：
  
  ```js
  let debounceTimer;
  
  function debounce(func, delay) {
  
    clearTimeout(debounceTimer);
  
    debounceTimer = setTimeout(func, delay);
  
  }
  
  uIOhook.uIOhook.on('mouseup', (e) => {
  
    debounce(() => {
  
      // 剪切板逻辑
  
    }, 300);
  
  });
  ```
  
  

#### **5.2 剪切板内容缓存**

- **原理**：将剪切板内容缓存到内存中，避免重复读取。

- **实现**：
  
  ```js
  let clipboardCache = clipboard.readText('clipboard');
  ```
  
  

#### **5.3 优化正则表达式**

- **原理**：根据业务需求优化正则表达式，支持更多号码格式。

- **实现**：
  
  ```js
  const reg = /^(1[3-9]\d{9}|0\d{2,3}-?\d{7,8}|400\d{7}|400\d{8}|10\d{3}|10\d{10})$/;
  ```
  
  

#### **5.4 小窗口显示优化**

- **原理**：限制小窗口的显示频率，避免频繁弹出。

- **实现**：
  
  ```js
  ```
  let lastShowTime = 0;
  
  function showWindow() {
  
    const now = Date.now();
  
    if (now - lastShowTime > 5000) {
  
      win.showInactive();
  
      lastShowTime = now;
  
    }
  
  }
  ```
  ```
  
  

---

### **6. 总结**

- **设计目标**：监听用户划词和复制操作，提取剪切板内容并验证其格式。
- **解决的问题**：实现划词取号功能，保护用户剪切板内容，优化用户体验。
- **节流思想**：限制操作频率，延时读取剪切板内容，避免高频触发。
- **易踩坑的点**：剪切板内容丢失、高频触发、正则验证不准确、小窗口显示问题。
- **优化方向**：使用防抖优化、剪切板内容缓存、优化正则表达式、小窗口显示优化。

通过这些优化，可以进一步提升剪切板功能的稳定性和用户体验。





```js

```
