åœ¨å‰ç«¯ï¼ˆä¸»è¦æŒ‡ JavaScriptï¼‰ä¸­ï¼Œâ€œ**åƒåœ¾å›æ”¶æœºåˆ¶ï¼ˆGarbage Collection, GCï¼‰**â€æ˜¯æµè§ˆå™¨ä¸ºäº†è‡ªåŠ¨ç®¡ç†å†…å­˜æ‰€æä¾›çš„æœºåˆ¶ã€‚JavaScript æ˜¯ä¸€ç§å…·æœ‰è‡ªåŠ¨å†…å­˜ç®¡ç†åŠŸèƒ½çš„è¯­è¨€ï¼Œä¸éœ€è¦å¼€å‘è€…æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ã€‚åƒåœ¾å›æ”¶çš„æ ¸å¿ƒç›®æ ‡æ˜¯**æ‰¾å‡ºä¸å†è¢«ä½¿ç”¨çš„å¯¹è±¡ï¼Œå¹¶é‡Šæ”¾å…¶å ç”¨çš„å†…å­˜**ã€‚

---

## ğŸ§  ä¸€ã€å‰ç«¯åƒåœ¾å›æ”¶çš„åŸºæœ¬æ¦‚å¿µ

### 1. ä»€ä¹ˆæ˜¯â€œåƒåœ¾â€ï¼Ÿ

åœ¨ JavaScript ä¸­ï¼Œ**â€œåƒåœ¾â€æ˜¯æŒ‡ç¨‹åºä¸­ä¸å†è¢«å¼•ç”¨çš„å†…å­˜å—**ã€‚ä¾‹å¦‚ï¼š

```javascript
let user = { name: "Alice" }; // user æŒ‡å‘ä¸€ä¸ªå¯¹è±¡
user = null; // åŸå¯¹è±¡ç°åœ¨æ— å¼•ç”¨ï¼Œå³ä¸ºåƒåœ¾
```

---

## âš™ï¸ äºŒã€åƒåœ¾å›æ”¶çš„å¸¸ç”¨ç®—æ³•

æµè§ˆå™¨ä¸»è¦ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§ GC ç®—æ³•ï¼š

### 1. å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰

- æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªâ€œå¼•ç”¨è®¡æ•°â€ã€‚

- å½“æœ‰ä¸€ä¸ªå˜é‡å¼•ç”¨è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œè®¡æ•°+1ï¼›å–æ¶ˆå¼•ç”¨æ—¶ï¼Œè®¡æ•°-1ã€‚

- å½“è®¡æ•°ä¸º 0ï¼Œå³å¯¹è±¡â€œæ— å¼•ç”¨â€ï¼Œå¯ä»¥å›æ”¶ã€‚

ğŸ“Œ **ç¼ºç‚¹**ï¼šæ— æ³•å¤„ç†â€œå¾ªç¯å¼•ç”¨â€ã€‚

```javascript
function cycle() {
  let a = {};
  let b = {};
  a.ref = b;
  b.ref = a;
  return "cycle done";
}
```

ä¸Šé¢ `a` å’Œ `b` äº’ç›¸å¼•ç”¨ï¼Œå³ä½¿å‡½æ•°ç»“æŸå®ƒä»¬ä¹Ÿæ— æ³•è¢«é‡Šæ”¾ï¼ˆåœ¨è€æ—§æµè§ˆå™¨ä¸­ï¼‰ã€‚

---

### 2. æ ‡è®°-æ¸…é™¤ï¼ˆMark and Sweepï¼‰

ç°ä»£æµè§ˆå™¨ï¼ˆå¦‚ V8 å¼•æ“ï¼‰ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚

- GC ä»â€œæ ¹å¯¹è±¡â€ï¼ˆå¦‚å…¨å±€å¯¹è±¡ `window`ï¼‰å¼€å§‹ã€‚

- éå†æ‰€æœ‰å¯è¾¾å¯¹è±¡ï¼Œæ ‡è®°ä¸ºâ€œæ´»åŠ¨çš„â€ã€‚

- æ‰€æœ‰**æœªè¢«æ ‡è®°çš„å¯¹è±¡**éƒ½è¢«è§†ä¸ºâ€œä¸å¯è¾¾â€ â†’ å›æ”¶ã€‚

ğŸ‘ ä¼˜ç‚¹ï¼š

- å¯ä»¥æ­£ç¡®å¤„ç†å¾ªç¯å¼•ç”¨ã€‚

---

## ğŸ—ï¸ ä¸‰ã€å¯è¾¾æ€§ï¼ˆReachabilityï¼‰

ä¸€ä¸ªå¯¹è±¡æ˜¯â€œå¯è¾¾çš„â€ï¼Œè¡¨ç¤ºå®ƒä»æ ¹å¯¹è±¡å¯è®¿é—®ã€‚æ ¹å¯¹è±¡åŒ…æ‹¬ï¼š

- å…¨å±€å¯¹è±¡ï¼ˆ`window` / `globalThis`ï¼‰

- å½“å‰æ‰§è¡Œæ ˆä¸­çš„å±€éƒ¨å˜é‡å’Œå‚æ•°

- é—­åŒ…å¼•ç”¨çš„å˜é‡

ä¸å¯è¾¾å¯¹è±¡ä¼šåœ¨ä¸‹ä¸€è½® GC ä¸­è¢«é”€æ¯ã€‚

---

## ğŸš€ å››ã€V8 å¼•æ“ä¸­çš„ä¼˜åŒ–æœºåˆ¶

V8ï¼ˆChrome å’Œ Node.js ä½¿ç”¨çš„ JS å¼•æ“ï¼‰ä½¿ç”¨æ›´é«˜çº§çš„æœºåˆ¶ï¼š

### V8 å†…å­˜ç»“æ„ï¼š

- **æ–°ç”Ÿä»£ï¼ˆNew Spaceï¼‰**ï¼šå­˜å‚¨ç”Ÿå‘½å‘¨æœŸçŸ­çš„å¯¹è±¡ã€‚

- **è€ç”Ÿä»£ï¼ˆOld Spaceï¼‰**ï¼šå­˜å‚¨ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ã€‚

V8 ä½¿ç”¨ï¼š

- **Scavengeï¼ˆå¤åˆ¶ç®—æ³•ï¼‰** å¤„ç†æ–°ç”Ÿä»£å†…å­˜ï¼ˆå¿«é€Ÿå›æ”¶ï¼‰

- **Mark-Sweep / Mark-Compact** å¤„ç†è€ç”Ÿä»£å†…å­˜ï¼ˆæ•ˆç‡é«˜ï¼‰

---

## ğŸ§¼ äº”ã€å¼€å‘è€…å¦‚ä½•ä¼˜åŒ–å†…å­˜ç®¡ç†ï¼Ÿ

è™½ç„¶ GC æ˜¯è‡ªåŠ¨çš„ï¼Œä½†ä½ å¯ä»¥ï¼š

- é¿å…ä¸å¿…è¦çš„å…¨å±€å˜é‡ï¼ˆè¿™äº›å˜é‡ç”Ÿå‘½å‘¨æœŸé•¿ï¼Œä¸æ˜“é‡Šæ”¾ï¼‰

- æ¸…ç†ä¸å†ä½¿ç”¨çš„ DOM å¼•ç”¨ï¼ˆå¦‚äº‹ä»¶ç›‘å¬å™¨ã€å®šæ—¶å™¨ï¼‰

- é¿å…åˆ›å»ºé—­åŒ…æ—¶æ— æ„ä¹‰çš„å˜é‡å¼•ç”¨

- ä½¿ç”¨å·¥å…·æ£€æµ‹å†…å­˜æ³„æ¼ï¼ˆChrome DevTools çš„ Memory é¢æ¿ï¼‰

---

## ğŸ§ª å…­ã€å¦‚ä½•æ£€æµ‹åƒåœ¾å›æ”¶ï¼Ÿ

å¼€å‘è€…å¯ä»¥ä½¿ç”¨ï¼š

- `console.profile()` å’Œ Chrome DevTools çš„ **Heap snapshot**

- `window.performance.memory`ï¼ˆä»…éƒ¨åˆ†æµè§ˆå™¨æ”¯æŒï¼‰

- å¼ºåˆ¶ GCï¼ˆé€šè¿‡ Chrome çš„ `--js-flags="--expose-gc"` é€‰é¡¹ä½¿ç”¨ `window.gc()`ï¼‰

---

å½“ç„¶ï¼Œä¸‹é¢æˆ‘åˆ—å‡º **ä¸‰ä¸ªå¸¸è§çš„ JavaScript å‰ç«¯å†…å­˜æ³„æ¼ä»£ç åœºæ™¯**ï¼Œç»“åˆåƒåœ¾å›æ”¶æœºåˆ¶ï¼ˆGCï¼‰è¯¦ç»†è§£é‡Šæ¯ä¸ªæ¡ˆä¾‹çš„â€œæ³„æ¼ç‚¹â€å’Œåº”å¯¹æ–¹æ³•ã€‚

---

## âœ… åœºæ™¯ 1ï¼š**é—­åŒ…å¯¼è‡´çš„å†…å­˜æ³„æ¼**

```javascript
function createLeak() {
  let bigData = new Array(1000000).fill("leak");

  return function () {
    console.log(bigData[0]);
  };
}

let leaky = createLeak(); // é—­åŒ…æŒæœ‰ bigData çš„å¼•ç”¨
```

### ğŸ” åˆ†æï¼š

- `bigData` æ˜¯ä¸€ä¸ªå¤§æ•°ç»„ï¼Œå ç”¨å¤§é‡å†…å­˜ã€‚

- å†…éƒ¨å‡½æ•°ï¼ˆé—­åŒ…ï¼‰å¼•ç”¨äº† `bigData`ï¼Œå³ä½¿ `createLeak()` æ‰§è¡Œå®Œæ¯•ï¼Œ`bigData` ä»ç„¶â€œå¯è¾¾â€ï¼Œä¸ä¼šè¢« GCã€‚

- **è§£å†³æ–¹æ¡ˆ**ï¼š
  
  - è‹¥ `leaky` ä¸å†éœ€è¦ï¼Œåº”å°†å…¶è®¾ä¸º `null`ï¼Œè®©é—­åŒ…å¯å›æ”¶ã€‚
  
  - æˆ–åœ¨é—­åŒ…ä¸­åªå¼•ç”¨æ‰€éœ€çš„å°éƒ¨åˆ†æ•°æ®ã€‚

```javascript
leaky = null; // bigData ä¼šè¢« GC å›æ”¶
```

---

## âœ… åœºæ™¯ 2ï¼š**æœªæ¸…é™¤äº‹ä»¶ç›‘å¬å™¨**

```javascript
const button = document.getElementById("myButton");

function handleClick() {
  console.log("Clicked");
}

button.addEventListener("click", handleClick);

// å‡è®¾ç¨åä½ ç§»é™¤äº†è¿™ä¸ªæŒ‰é’®å…ƒç´ 
button.remove(); // âŒ ç›‘å¬å™¨ä»åœ¨å†…å­˜ä¸­
```

### ğŸ” åˆ†æï¼š

- è™½ç„¶ DOM è¢«ç§»é™¤ï¼Œä½†äº‹ä»¶ç›‘å¬å™¨ä»ç»‘å®šåœ¨å†…å­˜ä¸­ï¼Œå¯¼è‡´ `button` å’Œ `handleClick` æ— æ³• GCã€‚

- **è§£å†³æ–¹æ¡ˆ**ï¼š
  
  - æ‰‹åŠ¨ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼š

```javascript
button.removeEventListener("click", handleClick);
button.remove(); // âœ… å¯è¢« GC
```

---

## âœ… åœºæ™¯ 3ï¼š**å®šæ—¶å™¨æœªæ¸…é™¤ï¼ˆsetIntervalï¼‰**

```javascript
function startTimer() {
  const data = new Array(1000000).fill("leak");

  setInterval(() => {
    console.log("Running", data[0]);
  }, 1000);
}

startTimer();
```

### ğŸ” åˆ†æï¼š

- `setInterval` ä¸­çš„é—­åŒ…å¼•ç”¨ `data`ï¼Œè€Œ `setInterval` æ°¸ä¸åœæ­¢ï¼Œå› æ­¤ `data` æ°¸ä¸è¢« GCã€‚

- **è§£å†³æ–¹æ¡ˆ**ï¼š
  
  - ä½¿ç”¨ `clearInterval` æ‰‹åŠ¨é‡Šæ”¾ï¼š

```javascript
function startTimer() {
  const data = new Array(1000000).fill("leak");
  const id = setInterval(() => {
    console.log("Running", data[0]);
  }, 1000);

  // å‡è®¾ 10 ç§’åç»“æŸ
  setTimeout(() => clearInterval(id), 10000);
}
```

---

## ğŸ” å¦‚ä½•éªŒè¯å†…å­˜æ³„æ¼ï¼Ÿ

æ‰“å¼€ **Chrome DevTools**ï¼š

1. `F12` â†’ Memory é¢æ¿

2. å½•åˆ¶ Heap Snapshot

3. è§‚å¯Ÿå¯¹è±¡æ˜¯å¦è¢«é‡Šæ”¾ï¼ˆçœ‹ retained size / detached DOM treesï¼‰

4. å¯åŠ æ–­ç‚¹è§‚å¯Ÿ GC è§¦å‘ä¸å¦

---
